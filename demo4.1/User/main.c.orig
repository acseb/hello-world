/**
* @file:main.c
* @copyright:Copyright 2020-2021 SGMW. Co. Ltd. All Rights Reserved.
* @brief:
* @detail:
* @author:郭轩铭
* @date:2020-11-27
* @version:v1.0
* @record:修改记录
*/
#include "reg52.h"			 //此文件中定义了单片机的一些特殊功能寄存器
#include "num.h"

u8 code smgduan[16]= {0x3f,0x06,0x5b,0x4f,0x66,0x6d,0x7d,0x07,
                      0x7f,0x6f,0x77,0x7c,0x39,0x5e,0x79,0x71
                     };//显示0~F的值

u8 light[6] = {0,0,0,0,0,0};

u16 num = 0;

sbit  test=P2^1;        // 测试灯
sbit  dula =P2^6;

sbit echo = P1^1;
sbit trig = P1^0;

u16   timeh,timel;
u16   flag,time;

/**
* @brief:中断器初始化
* @Name:Timer0Init
* @author: 郭轩铭
* @Data:2020-11-27
* @version:V1.0
* @param:空
* @return:空
**/
void Timer0Init()
{
//    TMOD|=0X01;//选择为定时器0模式，工作方式1，仅用TR0打开启动。

//    TH0=0XFC;	//给定时器赋初值，定时1ms
//    TL0=0X18;
//    ET0=1;//打开定时器0中断允许
//    EA=1;//打开总中断
//    TR0=1;//打开定时器

    TMOD=0x01;
    TH0=0;
    TL0=0;
    EA=0;
    ET0=0;
    EX0=0;
}

/**
* @brief:中断函数
* @Name:Timer0
* @author: 郭轩铭
* @Data:2020-11-27
* @version:V1.0
* @param:空
* @return:空
**/
void InitTimer0(void)
{
 TMOD = 0x09;
 TH0=0; //设置初值
 TL0=0;
 EA = 1;
 ET0 = 1;

}
void Timer0Interrupt(void) interrupt 1
{
 TH0=0; //设置初值
 TL0=0;
 flag=1;
}

void Conut(void)
{
 time=TH0*256+TL0;
 TH0=0;
 TL0=0;
 S=(time*1.7)/100; //算出来是CM 
DisplayNum();
}

/* 被调用子函数 */
void  diaoyong ()
{
    while(1)
 {
 TX=1;
 _nop_();_nop_();_nop_();_nop_();_nop_();_nop_();
 TX=0;
 while(!RX); //当RX为零时等待
 TR0=1; //开启计数
 while(RX); //当RX为1计数并等待
 TR0=0; //关闭计数
 Conut(); //计算
 delayms(280); //延时，反正发射信号对回响信号的影响
 }
    if(flag==1)        // 如果进入中断，说明测距已经测好
    {
        time= timeh *256+timel;// 计算测定距离，并显示
        num= time*0.1720;
        num = 5245;
        Cal();
    }
    if(flag==0)        // 如果没有进入中断，距离为 0 ，同时灯闪烁
    {
        num= 1;
        test =!test;
    }
}


/**
* @brief:主函数
* @Name:main
* @author: 郭轩铭
* @Data:2020-11-27
* @version:V1.0
* @param:空
* @return:空
**/
void main()
{
    Timer0Init();
//    echo = 0;
//    trig = 0;
    test= 0;
    trig= 0;
    EA=1;
    while(1)
    {
        diaoyong();
        DisplayNum();
    }
}
